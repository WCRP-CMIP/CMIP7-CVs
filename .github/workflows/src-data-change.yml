name: âˆ† src-data
description: Sync JSON and @context changes from src-data to production, applying relevant updates.

on:
  push:
    branches:
      - src-data
    paths:
      - '**/*.json'
      - '**/@context'
  workflow_dispatch:

jobs:

  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
      
      - name: Clean production except docs and summaries
        run: |
          shopt -s extglob
          rm -rf !(docs|summaries|.git)

      - name: Restore path from remote action
        uses: WCRP-CMIP/CMIPLD/actions/fetch_branch_path@main
        with:
          branch: "src-data"
          path: .
          remove: false

      
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Clean file upload from src-data"
          branch: production
          file_pattern: "*"
          author_name: "cmip-ipo"
          author_email: "actions@wcrp-cmip.org"
          commit_user_name: "cmip-ipo"
          commit_user_email: "actions@wcrp-cmip.org"
          push_options: "--force"




  graph:
    uses: WCRP-CMIP/CMIPLD/.github/workflows/graph.yml@main
    needs: sync
    
  # commit:
  #   runs-on: ubuntu-latest
  #   needs:
  #     - sync
  #     # - graph
  #   steps:
    
  #     - name: Checkout production branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: production
          
  #     - name: Download synced files artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: synced-files
  #         path: .

  #     - name: Configure Git and Commit Changes
  #       run: |
  #         git config user.name "cmipipo-actions[bot]"
  #         git config user.email "technical@wcrp-cmip.org"
  #         git add .
  #         git commit -m "Automated Content Update" || echo "No changes to commit"

  #     - name: Push PR
  #       uses: WCRP-CMIP/CMIPLD/actions/pushpr@main
  #       with:
  #         branch: "production"
  #         message: "Automated JSONLD update"
  #         token: ${{ secrets.GITHUB_TOKEN }}

  publish-pages:
    needs: 
      - graph
    uses: WCRP-CMIP/CMIPLD/.github/workflows/pages.yml@main
    with:
      branch: production
      force: true
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
